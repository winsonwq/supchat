<!-- 侧边栏遮罩层 -->
<view class="sidebar-mask {{isOpen ? 'sidebar-mask--open' : ''}}" bindtap="closeSidebar"></view>

<!-- 侧边栏主体 -->
<view class="sidebar {{isOpen ? 'sidebar--open' : ''}}" style="{{s.sidebarPaddingTop}}">
  <!-- 侧边栏头部 -->
  <view class="sidebar-header">
    <view class="sidebar-title-row">
      <text class="sidebar-title">聊天记录</text>
      <view 
        class="edit-mode-btn {{isEditMode ? 'edit-mode-btn--active' : ''}}" 
        bindtap="toggleEditMode"
      >
        <svg-icon 
          name="{{isEditMode ? 'check' : 'edit'}}" 
          size="32" 
          color="{{isEditMode ? '#1976d2' : '#666'}}" 
        />
      </view>
    </view>
  </view>

  <!-- 聊天会话列表 -->
  <scroll-view class="sidebar-content" scroll-y="true">
    <view class="chat-sessions-list">
      <view 
        wx:for="{{sortedChatSessions}}" 
        wx:key="id" 
        class="chat-session-item {{!isEditMode && currentSessionId === item.id ? 'chat-session-item--active' : ''}} {{isEditMode ? 'chat-session-item--edit-mode' : ''}}"
        bindtap="{{!isEditMode ? 'selectChatSession' : ''}}"
        data-session-id="{{item.id}}"
      >
        <view class="chat-session-content">
          <view class="chat-session-title">{{item.title || '未命名'}}</view>
          <view class="chat-session-time">{{item.displayTime}}</view>
        </view>
        <view class="chat-session-actions {{isEditMode ? 'chat-session-actions--visible' : ''}}">
          <view 
            wx:if="{{isEditMode}}"
            class="generate-title-btn" 
            bindtap="generateChatTitle" 
            data-session-id="{{item.id}}"
          >
            <svg-icon name="tool" size="32" color="#1976d2" />
          </view>
          <view 
            wx:if="{{isEditMode}}"
            class="delete-session-btn" 
            bindtap="deleteChatSession" 
            data-session-id="{{item.id}}"
          >
            <svg-icon name="delete" size="32" color="#ff4757" />
          </view>
        </view>
      </view>
      
      <!-- 空状态 -->
      <view wx:if="{{sortedChatSessions.length === 0}}" class="empty-state">
        <text class="empty-text">暂无聊天记录</text>
      </view>
    </view>
  </scroll-view>

  <!-- 新建话题按钮 -->
  <view class="sidebar-footer">
    <button class="new-topic-btn" bindtap="createNewTopic">
      <svg-icon name="plus" size="32" color="white" class="new-topic-icon"></svg-icon>
      <text class="new-topic-text">新建话题</text>
    </button>
  </view>

  <!-- 底部用户栏 -->
  <view class="sidebar-bottom-bar">
    <view class="user-info">
      <button class="user-avatar" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
        <!-- 如果有头像URL，显示图片 -->
        <image wx:if="{{localUserInfo && localUserInfo.avatar}}" 
               src="{{localUserInfo.avatar}}" 
               class="avatar-image"
               mode="aspectFill" />
        <!-- 否则显示文字头像 -->
        <text wx:else class="avatar-text">{{localUserInfo && localUserInfo.nickname ? localUserInfo.nickname.charAt(0) : 'U'}}</text>
      </button>
      <view class="user-name-wrapper">
        <button 
          class="user-name-btn" 
          bindtap="onEditNickname"
        >
          <text class="user-name">{{localUserInfo && localUserInfo.nickname || '点击设置昵称'}}</text>
        </button>
      </view>
    </view>
    <view>
      <button class="btn btn-icon" bindtap="openSettings">
        <svg-icon name="settings" size="40" class="settings-icon"></svg-icon>
      </button>
    </view>
  </view>
</view>

<!-- 昵称编辑对话框 -->
<nickname-dialog 
  isVisible="{{showNicknameDialog}}" 
  currentNickname="{{localUserInfo && localUserInfo.nickname || ''}}"
  bind:confirm="onNicknameConfirm"
  bind:close="onNicknameDialogClose"
/>

