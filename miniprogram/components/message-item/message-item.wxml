<!-- æ¶ˆæ¯å¡ç‰‡ç»„ä»¶ -->
<view 
  id="message-{{ messageIndex }}"
  class="p-6 space-y-4 {{ isLoading ? 'text-gray-800' : message.role === 'user' ? 'bg-white text-gray-800 rounded-lg overflow-hidden shadow-md' : message.role === 'tool' ? 'text-gray-800 rounded-lg overflow-hidden' : 'text-gray-800' }}"
>
  <!-- å¡ç‰‡å¤´éƒ¨ -->
  <view class="flex items-center justify-between">
    <text class="card-title text-xs font-medium text-gray-600">{{ isLoading ? 'AIåŠ©æ‰‹' : message.role === 'user' ? 'ç”¨æˆ·' : message.role === 'tool' ? 'å·¥å…·' : 'AIåŠ©æ‰‹' }}</text>
  </view>
  
  <!-- å·¥å…·è°ƒç”¨ä¿¡æ¯ - å¾ªç¯æ¸²æŸ“å½“å‰è°ƒç”¨çš„å·¥å…· -->
  <view wx:if="{{ message.tool_calls && message.tool_calls.length > 0 }}">
    <view class="mb-2">
      <text class="text-sm font-medium text-blue-600">æ­£åœ¨è°ƒç”¨å·¥å…·: </text>
    </view>
    <view wx:for="{{ message.tool_calls }}" wx:key="id" wx:for-item="toolCall" class="flex flex-col my-4 rounded border p-3">
      <view class="font-medium text-blue-700">{{toolCall.function.name}}</view>
      <view class="break-all leading-140 mt-1">
        <text class="text-xs text-gray-500">{{ toolCall.function.arguments }}</text>
      </view>
    </view>
  </view>
  
  <!-- å¡ç‰‡å†…å®¹ -->
  <view>
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{ isLoading }}" class="flex gap-2 items-center loading-dots">
      <view class="w-3 h-3 rounded-full bg-gray-400 loading-dot"></view>
      <view class="w-3 h-3 rounded-full bg-gray-400 loading-dot"></view>
      <view class="w-3 h-3 rounded-full bg-gray-400 loading-dot"></view>
    </view>
    <!-- æ­£å¸¸æ¶ˆæ¯å†…å®¹ -->
    <block wx:else>
      <!-- æ¶ˆæ¯å†…å®¹ -->
      <block wx:if="{{ message.content || message.towxmlNodes }}">
        <!-- æ£€æŸ¥æ˜¯å¦ä¸ºç»„ä»¶å†…å®¹ -->
        <block wx:if="{{ message.content && message.content.type === 'weather' }}">
          <!-- å¤©æ°”ç»„ä»¶å†…å®¹ -->
          <view class="weather-component-wrapper">
            <!-- ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºçš„viewç»„ä»¶æ¸²æŸ“å¤©æ°”ä¿¡æ¯ -->
            <view class="bg-gradient-to-br from-blue-50 to-indigo-100 p-4 rounded-lg">
              <view class="flex items-center justify-between mb-4">
                <text class="text-lg font-semibold text-gray-800">{{ message.content.miniProgramData.city }} å¤©æ°”</text>
                <text class="text-sm text-gray-500">{{ message.content.miniProgramData.updateTime }}</text>
              </view>
              
              <view class="grid grid-cols-2 gap-4 mb-4">
                <view class="text-center">
                  <text class="text-3xl font-bold text-blue-600">{{ message.content.miniProgramData.temperature.current }}Â°C</text>
                  <view class="text-sm text-gray-600">å½“å‰æ¸©åº¦</view>
                </view>
                <view class="text-center">
                  <text class="text-lg font-medium text-gray-800">{{ message.content.miniProgramData.weather }}</text>
                  <view class="text-sm text-gray-600">å¤©æ°”çŠ¶å†µ</view>
                </view>
              </view>
              
              <view class="grid grid-cols-3 gap-2 mb-4 text-sm">
                <view class="text-center">
                  <text class="font-medium text-gray-700">{{ message.content.miniProgramData.temperature.high }}Â°C</text>
                  <view class="text-gray-500">æœ€é«˜</view>
                </view>
                <view class="text-center">
                  <text class="font-medium text-gray-700">{{ message.content.miniProgramData.temperature.low }}Â°C</text>
                  <view class="text-gray-500">æœ€ä½</view>
                </view>
                <view class="text-center">
                  <text class="font-medium text-gray-700">{{ message.content.miniProgramData.humidity }}%</text>
                  <view class="text-gray-500">æ¹¿åº¦</view>
                </view>
              </view>
              
              <view class="flex space-x-2">
                <button 
                  class="flex-1 bg-blue-500 text-white rounded px-3 py-2 text-sm" 
                  data-component-id="{{ message.content.componentId }}"
                  bindtap="onWeatherRefresh"
                >
                  ğŸ”„ åˆ·æ–°
                </button>
                <button 
                  class="flex-1 bg-green-500 text-white rounded px-3 py-2 text-sm" 
                  data-component-id="{{ message.content.componentId }}"
                  bindtap="onWeatherShare"
                >
                  ğŸ“¤ åˆ†äº«
                </button>
                <button 
                  class="flex-1 bg-purple-500 text-white rounded px-3 py-2 text-sm" 
                  data-component-id="{{ message.content.componentId }}"
                  bindtap="onWeatherDetail"
                >
                  ğŸ“Š è¯¦æƒ…
                </button>
              </view>
            </view>
          </view>
        </block>
        <!-- ä½¿ç”¨ towxml æ¸²æŸ“ Markdown å†…å®¹ -->
        <towxml wx:elif="{{ message.towxmlNodes }}" nodes="{{ message.towxmlNodes }}" />
        <!-- å¦‚æœæ²¡æœ‰ towxml èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬ -->
        <text wx:else class="text-sm leading-relaxed whitespace-pre-wrap break-words">{{ message.content }}</text>
        <!-- æµå¼è¾“å…¥å…‰æ ‡ -->
        <view wx:if="{{ message.role === 'assistant' && isStreaming && isLast && message.content }}" class="streaming-cursor">
          <text class="text-blue-500">|</text>
        </view>
      </block>
    </block>
  </view>
</view>
