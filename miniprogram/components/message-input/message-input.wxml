<!-- 输入区域 -->
<view class="input-container w-full bg-white border-t border-gray-200 p-6 relative" style="padding-bottom: calc({{ bottomSafeHeight }}px);">

  <!-- 统一的输入模式容器 -->
  <view class="w-full flex flex-col gap-4 mb-4 border border-solid border-gray-300 bg-white rounded-2xl p-6">
    <!-- 输入模式切换区域 -->
    <view class="w-full flex items-center gap-3">
      <!-- 输入模式切换按钮 -->
      <button 
        class="btn-icon"
        bindtap="toggleInputMode"
      >
        <svg-icon wx:if="{{ !isVoiceMode }}" name="voice" size="40"></svg-icon>
        <svg-icon wx:if="{{ isVoiceMode }}" name="keyboard" size="40"></svg-icon>
      </button>
      
      <!-- 输入内容区域 -->
      <view class="flex-1">
        <!-- 文字输入框 -->
        <textarea
          wx:if="{{ !isVoiceMode }}"
          class="message-textarea w-full overflow-y-auto {{ textareaInitialHeight ? 'textarea-initial' : '' }}"
          placeholder="{{ isStreaming ? 'AI正在回复中...' : '你有什么想知道的，快来问问我' }}"
          value="{{ inputMessage }}"
          bindinput="onInputChange"
          bindconfirm="onConfirm"
          disabled="{{ isLoading }}"
          auto-height="{{ !textareaInitialHeight }}"
          maxlength="1000"
          show-confirm-bar="false"
          cursor-spacing="16"
          autofocus
        />
        
        <!-- 语音输入区域 -->
        <view wx:if="{{ isVoiceMode }}">
          <!-- 录音状态显示 -->
          <view class="voice-input-area" wx:if="{{ isRecording }}">
            <button 
              class="voice-button recording"
              disabled="{{ true }}"
            >
              录制中...
            </button>
          </view>
          
          <!-- 语音按钮 -->
          <view class="voice-input-area" wx:if="{{ !isRecording }}">
            <button 
              class="voice-button"
              bindtouchstart="startRecording"
              bindtouchend="stopRecording"
              bindtouchcancel="stopRecording"
              disabled="{{ isLoading }}"
            >
              按住说话
            </button>
          </view>
        </view>
      </view>
      
      <!-- 语音模式下的占位空间 -->
      <view wx:if="{{ isVoiceMode }}" style="width:36px"></view>
    </view>
    
    <!-- AI 配置按钮 + MCP 服务按钮 + 右侧设置/发送/停止按钮 -->
    <view class="w-full flex align-center justify-between">
      <view class="flex align-center gap-4">
        <!-- 设置按钮（整行最左侧） -->
        <button
          class="btn btn-icon"
          bindtap="onOpenAgentSettingSheet"
          aria-label="打开设置"
        >
          <svg-icon name="settings" size="40"></svg-icon>
        </button>
        <button class="btn btn-tiny" catchtap="onOpenAiConfigSheet">
          <svg-icon name="server" size="40"></svg-icon>
          AI 配置
        </button>
        <!-- 仅在 Agent 模式下显示“选择 Agent”按钮 -->
        <button 
          wx:if="{{ isAgentMode }}"
          class="btn btn-tiny" 
          catchtap="onOpenAgentSheet"
        >
          <svg-icon name="chat" size="40"></svg-icon>
          Agent
        </button>
        <!-- 仅在非 Agent 模式下显示 MCP 按钮 -->
        <button 
          wx:if="{{ !isAgentMode }}"
          class="btn btn-tiny" 
          catchtap="onOpenMcpSheet"
        >
          <svg-icon name="tool" size="40"></svg-icon>
          MCP
        </button>
      </view>

      <view class="flex align-center gap-4">
        <button
          wx:if="{{ isLoading || isStreaming }}"
          class="btn-cancel btn btn-icon bg-black text-white"
          bindtap="onCancel"
        >
          <svg-icon name="stop" size="36" color="white"></svg-icon>
        </button>

        <button
          wx:elif="{{ !isLoading && !isStreaming }}"
          class="btn-send btn btn-icon bg-black text-white"
          bindtap="onSend"
          disabled="{{ !canSend }}"
        >
          <svg-icon name="send-fill" size="36" color="white"></svg-icon>
        </button>
      </view>
    </view>
  </view>
  
  <!-- 底部提示文字 -->
  <view class="text-center text-xs text-gray-400 leading-tight">
    内容由 AI 生成，仅供参考
  </view>

  <!-- AI 配置选择抽屉 -->
  <bottom-sheet visible="{{ aiConfigSheetVisible }}" title="AI 配置" bind:close="onCloseAiConfigSheet">
    <view class="ai-config-list">
      <block wx:if="{{ aiConfigs.length > 0 }}">
        <block wx:for="{{ aiConfigs }}" wx:key="id">
          <view class="ai-config-item" bindtap="onSelectAiConfig" data-id="{{ item.id }}">
            <view class="ai-config-meta">
              <text class="ai-config-name">{{ item.name }}</text>
              <text class="ai-config-model">{{ item.model }}</text>
            </view>
            <view class="ai-config-radio">
              <radio checked="{{ item.isActive }}"></radio>
            </view>
          </view>
        </block>
      </block>
      <view class="ai-config-empty" wx:else>
        <text>暂无 AI 配置，可前往设置添加</text>
      </view>
    </view>
  </bottom-sheet>

  <!-- Agent 设置抽屉 -->
  <bottom-sheet visible="{{ agentSettingSheetVisible }}" title="Agent 设置" bind:close="onCloseAgentSettingSheet">
    <view class="agent-setting-list">
      <view class="agent-setting-item flex items-center justify-between py-4">
        <text class="text-base">开启 Agent 模式</text>
        <switch checked="{{ isAgentMode }}" bindchange="onToggleAgentMode"></switch>
      </view>
    </view>
  </bottom-sheet>

  <!-- Agent 选择抽屉 -->
  <bottom-sheet visible="{{ agentSheetVisible }}" title="选择 Agent" bind:close="onCloseAgentSheet">
    <view class="agent-list">
      <block wx:if="{{ agents.length > 0 }}">
        <block wx:for="{{ agents }}" wx:key="id">
          <view class="agent-item" bindtap="onSelectAgent" data-id="{{ item.id }}">
            <view class="agent-meta">
              <text class="agent-name">{{ item.name }}</text>
              <text class="agent-description">{{ item.description || '暂无描述' }}</text>
              <view class="agent-tools">
                <text class="agent-tools-text">工具: {{ item.mcpServers.length }} 个</text>
              </view>
            </view>
            <view class="agent-radio">
              <radio checked="{{ currentAgent && currentAgent.id === item.id }}"></radio>
            </view>
          </view>
        </block>
      </block>
      <view class="agent-empty flex flex-col justify-center min-h-32" wx:else>
        <text class="block">暂无可用的 Agent</text>
        <text class="block text-xs text-gray-400 mt-2">可前往设置页面创建 Agent</text>
      </view>
    </view>
  </bottom-sheet>

  <!-- MCP 选择抽屉 -->
  <bottom-sheet visible="{{ mcpSheetVisible }}" title="MCP 服务" bind:close="onCloseMcpSheet">
    <view class="mcp-list">
      <block wx:if="{{ mcpConfigs.length > 0 }}">
        <block wx:for="{{ mcpConfigs }}" wx:key="id">
          <view class="mcp-item">
            <view class="mcp-meta">
              <text class="mcp-name">{{ item.name }}</text>
              <view class="mcp-status">
                <view class="dot {{ item.isOnline ? 'online' : 'offline' }}"></view>
                <text class="status-text">{{ item.isOnline ? '在线' : '离线' }}</text>
              </view>
            </view>
            <switch class="mcp-switch" checked="{{ item.isMessageEnabled }}" bindchange="onToggleMcp" data-id="{{ item.id }}"></switch>
          </view>
        </block>
      </block>
      <view class="mcp-empty flex flex-col justify-center min-h-32" wx:else>
        <text class="block">暂无全局启用的 MCP 服务</text>
        <text class="block text-xs text-gray-400 mt-2">可前往设置页面启用 MCP 服务</text>
      </view>
    </view>
  </bottom-sheet>
</view>
