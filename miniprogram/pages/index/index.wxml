<!--index.wxml-->
<navigation-bar
  title="AI助手"
  back="{{ false }}"
  color="black"
  background="#FFF"
>
</navigation-bar>

<!-- 聊天历史区域 -->
<scroll-view
  class="chat-scroll-view"
  scroll-y="true"
  scroll-into-view="{{ scrollToMessage }}"
  scroll-with-animation="true"
  enhanced="true"
  show-scrollbar="false"
>
  <view class="flex flex-col gap-4 p-4" style="padding-bottom: 100px">
    <!-- 欢迎消息 -->
    <view wx:if="{{ messages.length === 0 }}" class="flex justify-center py-10">
      <view class="p-10 rounded-2xl text-center">
        <text class="text-lg font-bold mb-5"
          >欢迎使用AI助手</text
        >
        <text class="block text-sm leading-normal"
          >我是你的AI助手，有什么可以帮助你的吗？</text
        >

      </view>
    </view>

    <!-- 消息列表 -->
    <view
      wx:for="{{ messages }}"
      wx:key="index"
      id="message-{{ index }}"
      class="message-card mb-2 mx-5 {{ item.role === 'user' ? 'user-card bg-white text-gray-800 rounded-lg overflow-hidden shadow-md' : item.role === 'tool' ? 'tool-card rounded-lg overflow-hidden shadow-md border-l-4 border-blue-500' : 'ai-card text-gray-800' }}"
    >
      <!-- 卡片头部 -->
      <view class="card-header flex items-center justify-between">
        <text class="card-title text-xs font-medium text-gray-600">
          {{ item.role === 'user' ? '用户' : item.role === 'tool' ? '工具' : 'AI助手' }}
        </text>
        <!-- 流式响应指示器 -->
        <view wx:if="{{ item.role === 'assistant' && isStreaming && index === messages.length - 1 && !item.content }}" class="streaming-indicator flex items-center">
          <view class="flex gap-1 items-center">
            <text class="text-xs text-gray-500 ml-2">正在思考...</text>
          </view>
        </view>
      </view>
      
      <!-- 工具调用信息 -->
      <view wx:if="{{ item.tool_calls && item.tool_calls.length > 0 }}" class="tool-calls-info px-5 py-3">
        <view class="tool-calls-header mb-2">
          <text class="text-sm font-medium text-blue-600">正在调用工具:</text>
        </view>
        <view wx:for="{{ item.tool_calls }}" wx:key="id" wx:for-item="toolCall" class="tool-call-item flex flex-col mb-2 p-3 rounded">
          <view class="tool-call-name mb-1">
            <text class="text-xs font-medium text-gray-700">{{ toolCall.function.name }}</text>
          </view>
          <view class="tool-call-args">
            <text class="text-xs text-gray-500">参数: {{ toolCall.function.arguments }}</text>
          </view>
        </view>
      </view>
      
      <!-- 卡片内容 -->
      <view class="card-content">
        <!-- 使用 towxml 渲染 Markdown 内容 -->
        <towxml wx:if="{{ item.towxmlNodes }}" nodes="{{ item.towxmlNodes }}" />
        <!-- 如果没有 towxml 节点，显示原始文本 -->
        <text wx:else class="card-text text-sm leading-relaxed whitespace-pre-wrap">{{ item.content }}</text>
        <!-- 流式输入光标 -->
        <view wx:if="{{ item.role === 'assistant' && isStreaming && index === messages.length - 1 && item.content }}" class="streaming-cursor">
          <text class="text-blue-500">|</text>
        </view>
      </view>
    </view>

    <!-- 加载状态（仅在非流式模式下显示） -->
    <view wx:if="{{ isLoading && !isStreaming }}" class="message-card mb-2 mx-5 ai-card text-gray-800">
      <view class="card-header flex items-center justify-between">
        <text class="card-title text-xs font-medium text-gray-600">AI助手</text>
      </view>
      <view class="card-content">
        <view class="flex gap-2 items-center loading-dots">
          <view class="w-3 h-3 rounded-full bg-gray-400 loading-dot"></view>
          <view class="w-3 h-3 rounded-full bg-gray-400 loading-dot"></view>
          <view class="w-3 h-3 rounded-full bg-gray-400 loading-dot"></view>
        </view>
      </view>
    </view>
  </view>
</scroll-view>

<!-- 输入组件 -->
<message-input
  inputMessage="{{ inputMessage }}"
  isLoading="{{ isLoading }}"
  isStreaming="{{ isStreaming }}"
  bind:inputchange="onInputChange"
  bind:send="onSendMessage"
  bind:cancel="cancelRequest"
></message-input>
