# 微信同声传译插件集成说明

## 概述

本项目已成功集成微信同声传译插件（WechatSI），提供语音转文字和文字转语音功能。

## 功能特性

- 🎤 **语音转文字**：录制语音后自动转换为文字
- 🔊 **文字转语音**：将文字转换为语音播放
- 🌍 **多语言支持**：支持中文、英文等多种语言
- ⚡ **实时识别**：支持流式语音识别
- 🔄 **自动回退**：插件失败时自动使用模拟识别
- 🔧 **智能适配**：自动尝试多种 API 调用方式

## 配置说明

### 1. 插件配置

在 `miniprogram/app.json` 中已配置：

```json
{
  "plugins": {
    "WechatSI": {
      "version": "0.3.5",
      "provider": "wx069ba97219f66d99"
    }
  }
}
```

### 2. 权限配置

确保在 `project.config.json` 中启用了录音权限：

```json
{
  "setting": {
    "enhance": true
  }
}
```

## 使用方法

### 在 message-input 组件中

1. **切换输入模式**：点击语音/键盘图标切换
2. **语音输入**：长按"按住说话"按钮开始实时语音识别
3. **自动识别**：识别过程中实时显示，完成后自动转换为文字并发送

### 在代码中使用

```typescript
import wechatSI from '../../lib/mcp/tools/wechat-si'

// 实时语音识别
const result = await wechatSI.startRealtimeRecognition({
  lang: 'zh_CN',
  duration: 30000
})

// 文本翻译
const translation = await wechatSI.translateText(
  '你好世界', 'zh_CN', 'en_US'
)

// 语音合成
const speech = await wechatSI.textToSpeech('你好世界', 'zh_CN')
```

## 重要说明

### 语音识别方式

微信同声传译插件使用**实时语音识别**，而不是录音文件转文字：

1. **实时识别**：用户说话时实时识别，无需等待录音完成
2. **流式处理**：识别结果会实时返回，提供更好的用户体验
3. **自动停止**：达到最大时长或用户停止时自动结束识别

### 与传统录音的区别

- **传统录音**：先录音，再识别，有延迟
- **实时识别**：边说边识别，实时反馈，体验更好

## 智能 API 适配

插件集成使用微信同声传译插件的官方 API 方法：

### 语音识别
- `getRecordRecognitionManager()` - 获取语音识别管理器
- `recognizeVoice(options)` - 开始语音识别

### 文本翻译
- `translateText(content, lfrom, lto, tts)` - 文本翻译功能

### 语音合成
- `textToSpeech(content, lang)` - 文字转语音功能

### 参数说明

#### 语音识别
```typescript
// 获取语音识别管理器
const manager = wechatSI.getRecordRecognitionManager()

// 开始语音识别
const result = await wechatSI.recognizeVoice({
  lang: 'zh_CN',        // 语言代码
  duration: 30000       // 最大时长（毫秒）
})
```

#### 文本翻译
```typescript
// 中译英
const result = await wechatSI.translateText(
  '你好世界',           // 要翻译的文本
  'zh_CN',            // 源语言
  'en_US',            // 目标语言
  false               // 是否进行语音合成
)
```

#### 语音合成
```typescript
// 中文语音合成
const result = await wechatSI.textToSpeech(
  '你好世界',          // 要合成的文本
  'zh_CN'            // 语言代码
)
```

### 支持的语言
- `zh_CN` - 中国大陆
- `en_US` - 英语
- `zh_HK` - 香港
- `sichuanhua` - 四川话
- `yue` - 粤语

## 错误处理

插件集成包含完善的错误处理机制：

1. **插件初始化失败**：自动回退到模拟识别
2. **语音识别失败**：显示具体错误信息
3. **权限不足**：引导用户开启录音权限
4. **网络异常**：提供重试机制
5. **API 不兼容**：自动尝试多种调用方式

## 注意事项

1. **微信版本要求**：需要微信 7.0.0 及以上版本
2. **录音权限**：首次使用需要用户授权录音权限
3. **音频格式**：支持 mp3、wav、aac 等格式
4. **录音时长**：最长支持 30 秒录音
5. **网络要求**：需要稳定的网络连接

## 调试信息

在开发者工具控制台中可以看到详细的调试信息：

- 🔧 插件初始化状态和可用方法
- 🎤 语音识别过程和 API 尝试
- ✅ 识别成功结果
- ⚠️ 识别失败警告和回退尝试
- ❌ 错误异常信息

### 调试步骤

1. **检查插件加载**：查看控制台是否显示"微信同声传译插件加载成功"
2. **查看可用方法**：检查"可用方法"列表，确认包含 `translate` 方法
3. **测试语音识别**：尝试录音，观察 `translate` 方法的调用过程
4. **错误分析**：如果失败，查看具体的错误信息和回退机制

## 故障排除

### 插件无法加载
- 检查微信版本是否支持
- 确认网络连接正常
- 查看控制台错误信息

### 语音识别失败
- 检查录音权限是否开启
- 确认音频文件格式正确
- 验证网络连接稳定
- 查看控制台 API 尝试过程

### 识别结果不准确
- 尝试调整录音环境
- 检查语言设置是否正确
- 确认录音时长适中

### API 方法不存在
- 查看控制台显示的可用方法列表
- 确认插件版本是否支持所需功能
- 考虑更新插件版本

## 更新日志

- **v1.0.0** - 初始集成微信同声传译插件
- 支持语音转文字功能
- 支持文字转语音功能
- 集成到 message-input 组件
- 添加错误处理和回退机制
- **v1.1.0** - 添加智能 API 适配
- 自动尝试多种 API 调用方式
- 增强错误处理和调试信息
- 支持更多插件版本兼容性
